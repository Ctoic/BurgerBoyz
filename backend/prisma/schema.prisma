generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum UserRole {
  ADMIN
  CUSTOMER
}

enum OrderStatus {
  PLACED
  PREPARING
  READY_FOR_PICKUP
  OUT_FOR_DELIVERY
  DELIVERED
  CANCELLED
}

enum PaymentMethod {
  CASH
  STRIPE
}

enum FulfillmentType {
  DELIVERY
  PICKUP
}

enum DeliveryZoneType {
  POSTCODE_PREFIX
  CIRCLE
}

enum SupportSender {
  CUSTOMER
  ADMIN
}

enum EmailOtpPurpose {
  CUSTOMER_SIGNUP
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String?
  role         UserRole @default(CUSTOMER)
  name         String?
  phone        String?
  addressLine1 String?
  addressLine2 String?
  addressCity  String?
  addressPostcode String?
  addressInstructions String?
  orders       Order[]
  supportThread SupportThread?
  emailOtps     EmailOtp[]
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model MenuCategory {
  id        String     @id @default(uuid())
  name      String
  position  Int        @default(0)
  isActive  Boolean    @default(true)
  items     MenuItem[]
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
}

model MenuItem {
  id          String            @id @default(uuid())
  categoryId  String
  category    MenuCategory      @relation(fields: [categoryId], references: [id])
  name        String
  description String
  priceCents  Int
  imageUrl    String?
  isPopular   Boolean           @default(false)
  isActive    Boolean           @default(true)
  addOns      MenuItemAddOn[]
  orderItems  OrderItem[]
  dealBundleItems DealBundleItem[]
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
}

model AddOn {
  id        String           @id @default(uuid())
  name      String
  priceCents Int
  isActive  Boolean          @default(true)
  items     MenuItemAddOn[]
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
}

model MenuItemAddOn {
  id         String   @id @default(uuid())
  menuItemId String
  addOnId    String
  isDefault  Boolean @default(false)
  menuItem   MenuItem @relation(fields: [menuItemId], references: [id], onDelete: Cascade)
  addOn      AddOn    @relation(fields: [addOnId], references: [id], onDelete: Cascade)
}

model Order {
  id               String           @id @default(uuid())
  userId           String?
  user             User?            @relation(fields: [userId], references: [id])
  status           OrderStatus      @default(PLACED)
  paymentMethod    PaymentMethod
  fulfillmentType  FulfillmentType
  customerName     String?
  customerEmail    String?
  customerPhone    String?
  notes            String?
  addressId        String?
  address          Address?         @relation(fields: [addressId], references: [id])
  subtotalCents    Int
  deliveryFeeCents Int              @default(0)
  totalCents       Int
  items            OrderItem[]
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
}

model OrderItem {
  id             String           @id @default(uuid())
  orderId        String
  menuItemId     String?
  menuItem       MenuItem?        @relation(fields: [menuItemId], references: [id], onDelete: SetNull)
  name           String
  description    String?
  basePriceCents Int
  quantity       Int
  removals       String[]
  order          Order            @relation(fields: [orderId], references: [id], onDelete: Cascade)
  addOns         OrderItemAddOn[]
}

model OrderItemAddOn {
  id         String    @id @default(uuid())
  orderItemId String
  name       String
  priceCents Int
  orderItem  OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)
}

model Address {
  id          String   @id @default(uuid())
  line1       String
  line2       String?
  city        String
  postcode    String
  instructions String?
  latitude    Float?
  longitude   Float?
  orders      Order[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model StoreSettings {
  id              String   @id @default(uuid())
  storeName       String   @default("BurgerBoyz")
  pickupEnabled   Boolean  @default(true)
  deliveryEnabled Boolean  @default(true)
  deliveryFeeCents Int     @default(0)
  openTime        String   @default("11:00")
  closeTime       String   @default("22:00")
  storeLatitude   Float?
  storeLongitude  Float?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model DeliveryZone {
  id               String           @id @default(uuid())
  name             String
  type             DeliveryZoneType @default(POSTCODE_PREFIX)
  city             String?
  postcodePrefixes String[]         @default([])
  centerLatitude   Float?
  centerLongitude  Float?
  radiusMeters     Int?
  isActive         Boolean          @default(true)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
}

model Deal {
  id            String           @id @default(uuid())
  name          String
  description   String
  tag           String           @default("Deal")
  imageUrl      String?
  discountCents Int              @default(0)
  isActive      Boolean          @default(true)
  bundleItems   DealBundleItem[]
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
}

model DealBundleItem {
  id         String   @id @default(uuid())
  dealId     String
  menuItemId String
  quantity   Int
  position   Int      @default(0)
  deal       Deal     @relation(fields: [dealId], references: [id], onDelete: Cascade)
  menuItem   MenuItem @relation(fields: [menuItemId], references: [id], onDelete: Cascade)

  @@unique([dealId, menuItemId])
}

model SupportThread {
  id                 String           @id @default(uuid())
  userId             String           @unique
  user               User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  lastReadAtCustomer DateTime?
  lastReadAtAdmin    DateTime?
  messages           SupportMessage[]
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
}

model SupportMessage {
  id        String        @id @default(uuid())
  threadId  String
  thread    SupportThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  sender    SupportSender
  body      String
  createdAt DateTime      @default(now())
}

model EmailOtp {
  id                String          @id @default(uuid())
  email             String
  userId            String?
  user              User?           @relation(fields: [userId], references: [id], onDelete: SetNull)
  purpose           EmailOtpPurpose
  codeHash          String
  expiresAt         DateTime
  resendAvailableAt DateTime
  attempts          Int             @default(0)
  maxAttempts       Int             @default(5)
  usedAt            DateTime?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  @@index([email, purpose, createdAt(sort: Desc)])
  @@index([email, purpose, usedAt, expiresAt])
}
